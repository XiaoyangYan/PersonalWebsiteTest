{"ast":null,"code":"var request = require('request'),\n    utils = require(\"./utils\"),\n    urllib = require('url'),\n    packageDotJson = require('../package.json');\n\nexports.buildInitUrl = function (baseUrl) {\n  return utils.resolveUrl(baseUrl, 'session');\n};\n\nexports.emit = function (browser, method, url, data) {\n  if (typeof data === 'object') {\n    data = JSON.stringify(data);\n  }\n\n  if (typeof url === 'string') {\n    url = urllib.parse(url);\n  }\n\n  browser.emit('http', method, url.path.replace(browser.sessionID, ':sessionID').replace(browser.configUrl.pathname, ''), data);\n};\n\nexports.buildJsonCallUrl = function (baseUrl, sessionID, relPath, absPath) {\n  var path = ['session'];\n\n  if (sessionID) {\n    path.push('/', sessionID);\n  }\n\n  if (relPath) {\n    path.push(relPath);\n  }\n\n  if (absPath) {\n    path = [absPath];\n  }\n\n  path = path.join('');\n  return utils.resolveUrl(baseUrl, path);\n};\n\nexports.newHttpOpts = function (method, httpConfig) {\n  // this._httpConfig\n  var opts = {};\n  opts.method = method;\n  opts.headers = {};\n  opts.headers.Connection = 'keep-alive';\n  opts.headers['User-Agent'] = 'admc/wd/' + packageDotJson.version;\n  opts.timeout = httpConfig.timeout;\n  opts.rejectUnauthorized = httpConfig.rejectUnauthorized;\n\n  if (httpConfig.proxy) {\n    opts.proxy = httpConfig.proxy;\n  } // we need to check method here to cater for PUT and DELETE case\n\n\n  if (opts.method === 'GET' || opts.method === 'POST') {\n    opts.followAllRedirects = true;\n    opts.headers.Accept = 'application/json';\n  }\n\n  opts.prepareToSend = function (url, data) {\n    if (typeof data === 'object') {\n      data = JSON.stringify(data);\n    }\n\n    this.url = url;\n\n    if (opts.method === 'POST' || opts.method === 'PUT') {\n      this.headers['Content-Type'] = 'application/json; charset=UTF-8';\n      this.headers['Content-Length'] = Buffer.byteLength(data, 'utf8');\n      this.body = data;\n    }\n  };\n\n  return opts;\n};\n\nvar shouldRetryOn = function (err) {\n  return err.code === 'ECONNRESET' || err.code === 'ETIMEDOUT' || err.code === 'ESOCKETTIMEDOUT' || err.code === 'EPIPE';\n};\n\nvar requestWithRetry = function (httpOpts, httpConfig, emit, cb, attempts) {\n  request(httpOpts, function (err, res, data) {\n    if (!attempts) {\n      attempts = 1;\n    }\n\n    if (httpConfig.retries >= 0 && (httpConfig.retries === 0 || attempts - 1 <= httpConfig.retries) && err && shouldRetryOn(err)) {\n      emit('connection', err.code, 'Lost http connection retrying in ' + httpConfig.retryDelay + ' ms.', err);\n      setTimeout(function () {\n        requestWithRetry(httpOpts, httpConfig, emit, cb, attempts + 1);\n      }, httpConfig.retryDelay);\n    } else {\n      if (err) {\n        emit('connection', err.code, 'Unexpected error.', err);\n      }\n\n      cb(err, res, data);\n    }\n  });\n};\n\nexports.requestWithRetry = requestWithRetry;\n\nvar requestWithoutRetry = function (httpOpts, emit, cb) {\n  request(httpOpts, function (err, res, data) {\n    if (err) {\n      emit('connection', err.code, 'Unexpected error.', err);\n    }\n\n    cb(err, res, data);\n  });\n};\n\nexports.requestWithoutRetry = requestWithoutRetry;","map":{"version":3,"sources":["/home/yanxiaoyang/react-project/PersonalWebsiteTest/node_modules/wd/lib/http-utils.js"],"names":["request","require","utils","urllib","packageDotJson","exports","buildInitUrl","baseUrl","resolveUrl","emit","browser","method","url","data","JSON","stringify","parse","path","replace","sessionID","configUrl","pathname","buildJsonCallUrl","relPath","absPath","push","join","newHttpOpts","httpConfig","opts","headers","Connection","version","timeout","rejectUnauthorized","proxy","followAllRedirects","Accept","prepareToSend","Buffer","byteLength","body","shouldRetryOn","err","code","requestWithRetry","httpOpts","cb","attempts","res","retries","retryDelay","setTimeout","requestWithoutRetry"],"mappings":"AAAA,IAAIA,OAAO,GAAGC,OAAO,CAAC,SAAD,CAArB;AAAA,IACIC,KAAK,GAAGD,OAAO,CAAC,SAAD,CADnB;AAAA,IAEIE,MAAM,GAAGF,OAAO,CAAC,KAAD,CAFpB;AAAA,IAGIG,cAAc,GAAGH,OAAO,CAAC,iBAAD,CAH5B;;AAKAI,OAAO,CAACC,YAAR,GAAsB,UAASC,OAAT,EACtB;AACE,SAAOL,KAAK,CAACM,UAAN,CAAiBD,OAAjB,EAA0B,SAA1B,CAAP;AACD,CAHD;;AAKAF,OAAO,CAACI,IAAR,GAAc,UAASC,OAAT,EAAkBC,MAAlB,EAA0BC,GAA1B,EAA+BC,IAA/B,EACd;AACE,MAAI,OAAOA,IAAP,KAAgB,QAApB,EAA8B;AAC5BA,IAAAA,IAAI,GAAGC,IAAI,CAACC,SAAL,CAAeF,IAAf,CAAP;AACD;;AACD,MAAG,OAAOD,GAAP,KAAe,QAAlB,EAA4B;AAAEA,IAAAA,GAAG,GAAGT,MAAM,CAACa,KAAP,CAAaJ,GAAb,CAAN;AAA0B;;AACxDF,EAAAA,OAAO,CAACD,IAAR,CAAa,MAAb,EAAqBE,MAArB,EACEC,GAAG,CAACK,IAAJ,CAASC,OAAT,CAAiBR,OAAO,CAACS,SAAzB,EAAoC,YAApC,EACGD,OADH,CACWR,OAAO,CAACU,SAAR,CAAkBC,QAD7B,EACuC,EADvC,CADF,EAE8CR,IAF9C;AAID,CAVD;;AAYAR,OAAO,CAACiB,gBAAR,GAA2B,UAASf,OAAT,EAAkBY,SAAlB,EAA6BI,OAA7B,EAAsCC,OAAtC,EAA8C;AACvE,MAAIP,IAAI,GAAG,CAAC,SAAD,CAAX;;AACA,MAAGE,SAAH,EACE;AAAEF,IAAAA,IAAI,CAACQ,IAAL,CAAU,GAAV,EAAgBN,SAAhB;AAA6B;;AACjC,MAAGI,OAAH,EACE;AAAEN,IAAAA,IAAI,CAACQ,IAAL,CAAUF,OAAV;AAAqB;;AACzB,MAAGC,OAAH,EACE;AAAEP,IAAAA,IAAI,GAAG,CAACO,OAAD,CAAP;AAAmB;;AACvBP,EAAAA,IAAI,GAAGA,IAAI,CAACS,IAAL,CAAU,EAAV,CAAP;AAEA,SAAOxB,KAAK,CAACM,UAAN,CAAiBD,OAAjB,EAA0BU,IAA1B,CAAP;AACD,CAXD;;AAaAZ,OAAO,CAACsB,WAAR,GAAsB,UAAShB,MAAT,EAAiBiB,UAAjB,EAA6B;AACjD;AACA,MAAIC,IAAI,GAAG,EAAX;AAEAA,EAAAA,IAAI,CAAClB,MAAL,GAAcA,MAAd;AACAkB,EAAAA,IAAI,CAACC,OAAL,GAAe,EAAf;AAEAD,EAAAA,IAAI,CAACC,OAAL,CAAaC,UAAb,GAA0B,YAA1B;AACAF,EAAAA,IAAI,CAACC,OAAL,CAAa,YAAb,IAA6B,aAAa1B,cAAc,CAAC4B,OAAzD;AACAH,EAAAA,IAAI,CAACI,OAAL,GAAeL,UAAU,CAACK,OAA1B;AACAJ,EAAAA,IAAI,CAACK,kBAAL,GAA0BN,UAAU,CAACM,kBAArC;;AACA,MAAGN,UAAU,CAACO,KAAd,EAAqB;AAAEN,IAAAA,IAAI,CAACM,KAAL,GAAaP,UAAU,CAACO,KAAxB;AAAgC,GAXN,CAYjD;;;AACA,MAAGN,IAAI,CAAClB,MAAL,KAAgB,KAAhB,IAAyBkB,IAAI,CAAClB,MAAL,KAAgB,MAA5C,EAAmD;AACjDkB,IAAAA,IAAI,CAACO,kBAAL,GAA0B,IAA1B;AACAP,IAAAA,IAAI,CAACC,OAAL,CAAaO,MAAb,GAAsB,kBAAtB;AACD;;AAEDR,EAAAA,IAAI,CAACS,aAAL,GAAqB,UAAS1B,GAAT,EAAcC,IAAd,EAAoB;AACvC,QAAI,OAAOA,IAAP,KAAgB,QAApB,EAA8B;AAC5BA,MAAAA,IAAI,GAAGC,IAAI,CAACC,SAAL,CAAeF,IAAf,CAAP;AACD;;AACD,SAAKD,GAAL,GAAWA,GAAX;;AACA,QAAIiB,IAAI,CAAClB,MAAL,KAAgB,MAAhB,IAA0BkB,IAAI,CAAClB,MAAL,KAAgB,KAA9C,EAAqD;AACnD,WAAKmB,OAAL,CAAa,cAAb,IAA+B,iCAA/B;AACA,WAAKA,OAAL,CAAa,gBAAb,IAAiCS,MAAM,CAACC,UAAP,CAAkB3B,IAAlB,EAAwB,MAAxB,CAAjC;AACA,WAAK4B,IAAL,GAAY5B,IAAZ;AACD;AACF,GAVD;;AAWA,SAAOgB,IAAP;AACD,CA9BD;;AAgCA,IAAIa,aAAa,GAAG,UAASC,GAAT,EAAc;AAC9B,SAAOA,GAAG,CAACC,IAAJ,KAAa,YAAb,IACHD,GAAG,CAACC,IAAJ,KAAa,WADV,IAEHD,GAAG,CAACC,IAAJ,KAAa,iBAFV,IAGHD,GAAG,CAACC,IAAJ,KAAa,OAHjB;AAIH,CALD;;AAOA,IAAIC,gBAAgB,GAAG,UAASC,QAAT,EAAmBlB,UAAnB,EAA+BnB,IAA/B,EAAqCsC,EAArC,EAAyCC,QAAzC,EAAmD;AACxEhD,EAAAA,OAAO,CAAC8C,QAAD,EAAW,UAASH,GAAT,EAAcM,GAAd,EAAmBpC,IAAnB,EAAyB;AACzC,QAAG,CAACmC,QAAJ,EAAc;AAAEA,MAAAA,QAAQ,GAAG,CAAX;AAAe;;AAC/B,QAAIpB,UAAU,CAACsB,OAAX,IAAsB,CAAtB,KACDtB,UAAU,CAACsB,OAAX,KAAuB,CAAvB,IAA6BF,QAAQ,GAAE,CAAX,IAAiBpB,UAAU,CAACsB,OADvD,KAEFP,GAFE,IAEMD,aAAa,CAACC,GAAD,CAFvB,EAE+B;AAC7BlC,MAAAA,IAAI,CAAC,YAAD,EAAekC,GAAG,CAACC,IAAnB,EAA0B,sCAAsChB,UAAU,CAACuB,UAAjD,GAA8D,MAAxF,EAAgGR,GAAhG,CAAJ;AACAS,MAAAA,UAAU,CAAC,YAAW;AACpBP,QAAAA,gBAAgB,CAACC,QAAD,EAAWlB,UAAX,EAAuBnB,IAAvB,EAA6BsC,EAA7B,EAAiCC,QAAQ,GAAG,CAA5C,CAAhB;AACD,OAFS,EAEPpB,UAAU,CAACuB,UAFJ,CAAV;AAGD,KAPD,MAOO;AACL,UAAGR,GAAH,EAAQ;AACNlC,QAAAA,IAAI,CAAC,YAAD,EAAekC,GAAG,CAACC,IAAnB,EAAyB,mBAAzB,EAA+CD,GAA/C,CAAJ;AACD;;AACDI,MAAAA,EAAE,CAACJ,GAAD,EAAMM,GAAN,EAAWpC,IAAX,CAAF;AACD;AACF,GAfM,CAAP;AAgBD,CAjBD;;AAkBAR,OAAO,CAACwC,gBAAR,GAA2BA,gBAA3B;;AAEA,IAAIQ,mBAAmB,GAAG,UAASP,QAAT,EAAmBrC,IAAnB,EAAyBsC,EAAzB,EAA6B;AACrD/C,EAAAA,OAAO,CAAC8C,QAAD,EAAW,UAASH,GAAT,EAAcM,GAAd,EAAmBpC,IAAnB,EAAyB;AACzC,QAAG8B,GAAH,EAAQ;AACNlC,MAAAA,IAAI,CAAC,YAAD,EAAekC,GAAG,CAACC,IAAnB,EAAyB,mBAAzB,EAA+CD,GAA/C,CAAJ;AACD;;AACDI,IAAAA,EAAE,CAACJ,GAAD,EAAMM,GAAN,EAAWpC,IAAX,CAAF;AACD,GALM,CAAP;AAMD,CAPD;;AAQAR,OAAO,CAACgD,mBAAR,GAA8BA,mBAA9B","sourcesContent":["var request = require('request'),\n    utils = require(\"./utils\"),\n    urllib = require('url'),\n    packageDotJson = require('../package.json');\n\nexports.buildInitUrl =function(baseUrl)\n{\n  return utils.resolveUrl(baseUrl, 'session');\n};\n\nexports.emit =function(browser ,method, url, data)\n{\n  if (typeof data === 'object') {\n    data = JSON.stringify(data);\n  }\n  if(typeof url === 'string') { url = urllib.parse(url); }\n  browser.emit('http', method,\n    url.path.replace(browser.sessionID, ':sessionID')\n      .replace(browser.configUrl.pathname, ''), data\n    );\n};\n\nexports.buildJsonCallUrl = function(baseUrl ,sessionID, relPath, absPath){\n  var path = ['session'];\n  if(sessionID)\n    { path.push('/' , sessionID); }\n  if(relPath)\n    { path.push(relPath); }\n  if(absPath)\n    { path = [absPath]; }\n  path = path.join('');\n\n  return utils.resolveUrl(baseUrl, path);\n};\n\nexports.newHttpOpts = function(method, httpConfig) {\n  // this._httpConfig\n  var opts = {};\n\n  opts.method = method;\n  opts.headers = {};\n\n  opts.headers.Connection = 'keep-alive';\n  opts.headers['User-Agent'] = 'admc/wd/' + packageDotJson.version;\n  opts.timeout = httpConfig.timeout;\n  opts.rejectUnauthorized = httpConfig.rejectUnauthorized;\n  if(httpConfig.proxy) { opts.proxy = httpConfig.proxy; }\n  // we need to check method here to cater for PUT and DELETE case\n  if(opts.method === 'GET' || opts.method === 'POST'){\n    opts.followAllRedirects = true;\n    opts.headers.Accept = 'application/json';\n  }\n\n  opts.prepareToSend = function(url, data) {\n    if (typeof data === 'object') {\n      data = JSON.stringify(data);\n    }\n    this.url = url;\n    if (opts.method === 'POST' || opts.method === 'PUT') {\n      this.headers['Content-Type'] = 'application/json; charset=UTF-8';\n      this.headers['Content-Length'] = Buffer.byteLength(data, 'utf8');\n      this.body = data;\n    }\n  };\n  return opts;\n};\n\nvar shouldRetryOn = function(err) {\n    return err.code === 'ECONNRESET' ||\n        err.code === 'ETIMEDOUT' ||\n        err.code === 'ESOCKETTIMEDOUT' ||\n        err.code === 'EPIPE';\n};\n\nvar requestWithRetry = function(httpOpts, httpConfig, emit, cb, attempts) {\n  request(httpOpts, function(err, res, data) {\n    if(!attempts) { attempts = 1; }\n    if( httpConfig.retries >= 0 &&\n      (httpConfig.retries === 0 || (attempts -1) <= httpConfig.retries) &&\n      err && (shouldRetryOn(err))) {\n      emit('connection', err.code , 'Lost http connection retrying in ' + httpConfig.retryDelay + ' ms.', err);\n      setTimeout(function() {\n        requestWithRetry(httpOpts, httpConfig, emit, cb, attempts + 1 );\n      }, httpConfig.retryDelay);\n    } else {\n      if(err) {\n        emit('connection', err.code, 'Unexpected error.' , err);\n      }\n      cb(err, res, data);\n    }\n  });\n};\nexports.requestWithRetry = requestWithRetry;\n\nvar requestWithoutRetry = function(httpOpts, emit, cb) {\n  request(httpOpts, function(err, res, data) {\n    if(err) {\n      emit('connection', err.code, 'Unexpected error.' , err);\n    }\n    cb(err, res, data);\n  });\n};\nexports.requestWithoutRetry = requestWithoutRetry;\n"]},"metadata":{},"sourceType":"script"}