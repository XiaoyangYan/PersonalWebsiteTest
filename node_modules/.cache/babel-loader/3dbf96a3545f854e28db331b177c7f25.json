{"ast":null,"code":"var promise = require('./promise'),\n    flatten = require('./flatten'),\n    def = require('./def'),\n    noop = function () {};\n\nmodule.exports = function emitterify(body, hooks) {\n  body = body || {};\n  hooks = hooks || {};\n  def(body, 'emit', emit, 1);\n  def(body, 'once', once, 1);\n  def(body, 'off', off, 1);\n  def(body, 'on', on, 1);\n  body.on['*'] = body.on['*'] || [];\n  return body;\n\n  function emit(type, pm, filter) {\n    var li = body.on[type.split('.')[0]] || [],\n        results = [];\n\n    for (var i = 0; i < li.length; i++) if (!li[i].ns || !filter || filter(li[i].ns)) results.push(call(li[i].isOnce ? li.splice(i--, 1)[0] : li[i], pm));\n\n    for (var i = 0; i < body.on['*'].length; i++) results.push(call(body.on['*'][i], [type, pm]));\n\n    return results.reduce(flatten, []);\n  }\n\n  function call(cb, pm) {\n    return cb.next ? cb.next(pm) : pm instanceof Array ? cb.apply(body, pm) : cb.call(body, pm);\n  }\n\n  function on(type, opts, isOnce) {\n    var id = type.split('.')[0],\n        ns = type.split('.')[1],\n        li = body.on[id] = body.on[id] || [],\n        cb = typeof opts == 'function' ? opts : 0;\n    return !cb && ns ? (cb = body.on[id]['$' + ns]) ? cb : push(observable(body, opts)) : !cb && !ns ? push(observable(body, opts)) : cb && ns ? push((remove(li, body.on[id]['$' + ns] || -1), cb)) : cb && !ns ? push(cb) : false;\n\n    function push(cb) {\n      cb.isOnce = isOnce;\n      cb.type = id;\n      if (ns) body.on[id]['$' + (cb.ns = ns)] = cb;\n      li.push(cb);\n      (hooks.on || noop)(cb);\n      return cb.next ? cb : body;\n    }\n  }\n\n  function once(type, callback) {\n    return body.on(type, callback, true);\n  }\n\n  function remove(li, cb) {\n    var i = li.length;\n\n    while (~--i) if (cb == li[i] || cb == li[i].fn || !cb) (hooks.off || noop)(li.splice(i, 1)[0]);\n  }\n\n  function off(type, cb) {\n    remove(body.on[type] || [], cb);\n    if (cb && cb.ns) delete body.on[type]['$' + cb.ns];\n    return body;\n  }\n\n  function observable(parent, opts) {\n    opts = opts || {};\n    var o = emitterify(opts.base || promise());\n    o.i = 0;\n    o.li = [];\n    o.fn = opts.fn;\n    o.parent = parent;\n    o.source = opts.fn ? o.parent.source : o;\n    o.on('stop', function (reason) {\n      o.type ? o.parent.off(o.type, o) : o.parent.off(o);\n      return o.reason = reason;\n    });\n\n    o.each = function (fn) {\n      var n = fn.next ? fn : observable(o, {\n        fn: fn\n      });\n      o.li.push(n);\n      return n;\n    };\n\n    o.pipe = function (fn) {\n      return fn(o);\n    };\n\n    o.map = function (fn) {\n      return o.each(function (d, i, n) {\n        return n.next(fn(d, i, n));\n      });\n    };\n\n    o.filter = function (fn) {\n      return o.each(function (d, i, n) {\n        return fn(d, i, n) && n.next(d);\n      });\n    };\n\n    o.reduce = function (fn, acc) {\n      return o.each(function (d, i, n) {\n        return n.next(acc = fn(acc, d, i, n));\n      });\n    };\n\n    o.unpromise = function () {\n      var n = observable(o, {\n        base: {},\n        fn: function (d) {\n          return n.next(d);\n        }\n      });\n      o.li.push(n);\n      return n;\n    };\n\n    o.next = function (value) {\n      o.resolve && o.resolve(value);\n      return o.li.length ? o.li.map(function (n) {\n        return n.fn(value, n.i++, n);\n      }) : value;\n    };\n\n    o.until = function (stop) {\n      return !stop ? 0 : stop.each ? stop.each(o.stop) // TODO: check clean up on stop too\n      : stop.then ? stop.then(o.stop) : stop.call ? o.filter(stop).map(o.stop) : 0;\n    };\n\n    o.off = function (fn) {\n      return remove(o.li, fn), o;\n    };\n\n    o.start = function (stop) {\n      o.until(stop);\n      o.source.emit('start');\n      return o;\n    };\n\n    o.stop = function (reason) {\n      return o.source.emit('stop', reason);\n    };\n\n    o[Symbol.asyncIterator] = function () {\n      return {\n        next: function () {\n          return o.wait = new Promise(function (resolve) {\n            o.wait = true;\n            o.map(function (d, i, n) {\n              delete o.wait;\n              o.off(n);\n              resolve({\n                value: d,\n                done: false\n              });\n            });\n            o.emit('pull', o);\n          });\n        }\n      };\n    };\n\n    return o;\n  }\n};","map":{"version":3,"sources":["/home/yanxiaoyang/react-project/PersonalWebsiteTest/node_modules/utilise/emitterify.js"],"names":["promise","require","flatten","def","noop","module","exports","emitterify","body","hooks","emit","once","off","on","type","pm","filter","li","split","results","i","length","ns","push","call","isOnce","splice","reduce","cb","next","Array","apply","opts","id","observable","remove","callback","fn","parent","o","base","source","reason","each","n","pipe","map","d","acc","unpromise","value","resolve","until","stop","then","start","Symbol","asyncIterator","wait","Promise","done"],"mappings":"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","sourcesContent":["var promise = require('./promise')\r\n  , flatten = require('./flatten')\r\n  , def     = require('./def')\r\n  , noop = function(){}\r\n\r\nmodule.exports = function emitterify(body, hooks) {\r\n  body = body || {}\r\n  hooks = hooks || {}\r\n  def(body, 'emit', emit, 1)\r\n  def(body, 'once', once, 1)\r\n  def(body, 'off', off, 1)\r\n  def(body, 'on', on, 1)\r\n  body.on['*'] = body.on['*'] || []\r\n  return body\r\n\r\n  function emit(type, pm, filter) {\r\n    var li = body.on[type.split('.')[0]] || []\r\n      , results = []\r\n\r\n    for (var i = 0; i < li.length; i++)\r\n      if (!li[i].ns || !filter || filter(li[i].ns))\r\n        results.push(call(li[i].isOnce ? li.splice(i--, 1)[0] : li[i], pm))\r\n\r\n    for (var i = 0; i < body.on['*'].length; i++)\r\n      results.push(call(body.on['*'][i], [type, pm]))\r\n\r\n    return results.reduce(flatten, [])\r\n  }\r\n\r\n  function call(cb, pm){\r\n    return cb.next             ? cb.next(pm) \r\n         : pm instanceof Array ? cb.apply(body, pm) \r\n                               : cb.call(body, pm) \r\n  }\r\n\r\n  function on(type, opts, isOnce) {\r\n    var id = type.split('.')[0]\r\n      , ns = type.split('.')[1]\r\n      , li = body.on[id] = body.on[id] || []\r\n      , cb = typeof opts == 'function' ? opts : 0\r\n\r\n    return !cb &&  ns ? (cb = body.on[id]['$'+ns]) ? cb : push(observable(body, opts))\r\n         : !cb && !ns ? push(observable(body, opts))\r\n         :  cb &&  ns ? push((remove(li, body.on[id]['$'+ns] || -1), cb))\r\n         :  cb && !ns ? push(cb)\r\n                      : false\r\n\r\n    function push(cb){\r\n      cb.isOnce = isOnce\r\n      cb.type = id\r\n      if (ns) body.on[id]['$'+(cb.ns = ns)] = cb\r\n      li.push(cb)\r\n      ;(hooks.on || noop)(cb)\r\n      return cb.next ? cb : body\r\n    }\r\n  }\r\n\r\n  function once(type, callback){\r\n    return body.on(type, callback, true)\r\n  }\r\n\r\n  function remove(li, cb) {\r\n    var i = li.length\r\n    while (~--i) \r\n      if (cb == li[i] || cb == li[i].fn || !cb)\r\n        (hooks.off || noop)(li.splice(i, 1)[0])\r\n  }\r\n\r\n  function off(type, cb) {\r\n    remove((body.on[type] || []), cb)\r\n    if (cb && cb.ns) delete body.on[type]['$'+cb.ns]\r\n    return body\r\n  }\r\n\r\n  function observable(parent, opts) {\r\n    opts = opts || {}\r\n    var o = emitterify(opts.base || promise())\r\n    o.i = 0\r\n    o.li = []\r\n    o.fn = opts.fn\r\n    o.parent = parent\r\n    o.source = opts.fn ? o.parent.source : o\r\n    \r\n    o.on('stop', function(reason){\r\n      o.type\r\n        ? o.parent.off(o.type, o)\r\n        : o.parent.off(o)\r\n      return o.reason = reason\r\n    })\r\n\r\n    o.each = function(fn) {\r\n      var n = fn.next ? fn : observable(o, { fn: fn })\r\n      o.li.push(n)\r\n      return n\r\n    }\r\n\r\n    o.pipe = function(fn) {\r\n      return fn(o)\r\n    }\r\n\r\n    o.map = function(fn){\r\n      return o.each(function(d, i, n){ return n.next(fn(d, i, n)) })\r\n    }\r\n\r\n    o.filter = function(fn){\r\n      return o.each(function(d, i, n){ return fn(d, i, n) && n.next(d) })\r\n    }\r\n\r\n    o.reduce = function(fn, acc) {\r\n      return o.each(function(d, i, n){ return n.next(acc = fn(acc, d, i, n)) })\r\n    }\r\n\r\n    o.unpromise = function(){ \r\n      var n = observable(o, { base: {}, fn: function(d){ return n.next(d) } })\r\n      o.li.push(n)\r\n      return n\r\n    }\r\n\r\n    o.next = function(value) {\r\n      o.resolve && o.resolve(value)\r\n      return o.li.length \r\n           ? o.li.map(function(n){ return n.fn(value, n.i++, n) })\r\n           : value\r\n    }\r\n\r\n    o.until = function(stop){\r\n      return !stop     ? 0\r\n           : stop.each ? stop.each(o.stop) // TODO: check clean up on stop too\r\n           : stop.then ? stop.then(o.stop)\r\n           : stop.call ? o.filter(stop).map(o.stop)\r\n                       : 0\r\n    }\r\n\r\n    o.off = function(fn){\r\n      return remove(o.li, fn), o\r\n    }\r\n\r\n    o.start = function(stop){\r\n      o.until(stop)\r\n      o.source.emit('start')\r\n      return o\r\n    }\r\n\r\n    o.stop = function(reason){\r\n      return o.source.emit('stop', reason)\r\n    }\r\n\r\n    o[Symbol.asyncIterator] = function(){ \r\n      return { \r\n        next: function(){ \r\n          return o.wait = new Promise(function(resolve){\r\n            o.wait = true\r\n            o.map(function(d, i, n){\r\n              delete o.wait\r\n              o.off(n)\r\n              resolve({ value: d, done: false })\r\n            })\r\n            o.emit('pull', o)\r\n          })\r\n        }\r\n      }\r\n    }\r\n\r\n    return o\r\n  }\r\n}"]},"metadata":{},"sourceType":"script"}