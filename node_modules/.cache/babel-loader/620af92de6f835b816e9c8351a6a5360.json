{"ast":null,"code":"var EventEmitter = require('events').EventEmitter,\n    _ = require(\"lodash\"),\n    util = require('util'),\n    url = require('url'),\n    http = require('http'),\n    __slice = Array.prototype.slice,\n    utils = require(\"./utils\"),\n    findCallback = utils.findCallback,\n    niceArgs = utils.niceArgs,\n    niceResp = utils.niceResp,\n    strip = utils.strip,\n    deprecator = utils.deprecator,\n    httpUtils = require('./http-utils'),\n    config = require('./config'),\n    Element = require('./element'),\n    commands = require('./commands'),\n    SAUCE_API_HOST = process.env[\"SAUCE_API_HOST\"] || \"saucelabs.com\"; // Webdriver client main class\n// configUrl: url object constructed via url.parse\n\n\nvar Webdriver = module.exports = function (configUrl) {\n  EventEmitter.call(this);\n  this.sessionID = null;\n  this.httpAgent = null;\n  this.configUrl = configUrl;\n  this.sauceTestPageRoot = \"https://\" + SAUCE_API_HOST + \"/jobs\";\n  this.sauceRestRoot = \"https://\" + SAUCE_API_HOST + \"/rest/v1\"; // config url without auth\n\n  this.noAuthConfigUrl = url.parse(url.format(this.configUrl));\n  delete this.noAuthConfigUrl.auth;\n  this.defaultCapabilities = {\n    browserName: 'firefox',\n    version: '',\n    javascriptEnabled: true,\n    platform: 'ANY'\n  };\n  this._httpConfig = _.clone(config.httpConfig);\n}; //inherit from EventEmitter\n\n\nutil.inherits(Webdriver, EventEmitter); // creates a new element\n\nWebdriver.prototype.newElement = function (jsonWireElement) {\n  return new Element(jsonWireElement, this);\n};\n/**\n * attach(sessionID, cb) -> cb(err)\n * Connect to an already-active session.\n */\n\n\nWebdriver.prototype.attach = function (sessionID) {\n  var cb = findCallback(arguments);\n  this.sessionID = sessionID;\n\n  if (cb) {\n    cb(null);\n  }\n};\n/**\n * detach(cb) -> cb(err)\n * Detach from the current session.\n */\n\n\nWebdriver.prototype.detach = function () {\n  var cb = findCallback(arguments);\n  this.sessionID = null;\n\n  if (cb) {\n    cb(null);\n  }\n};\n\ncommands.chain = function (obj) {\n  deprecator.warn('chain', 'chain api has been deprecated, use promise chain instead.');\n\n  require(\"./deprecated-chain\").patch(this);\n\n  return this.chain(obj);\n};\n\nWebdriver.prototype._init = function () {\n  delete this.sessionID;\n\n  var _this = this;\n\n  var fargs = utils.varargs(arguments);\n  var cb = fargs.callback,\n      desired = fargs.all[0] || {};\n\n  var _desired = _.clone(desired);\n\n  if (desired.deviceName || desired.device || desired.wdNoDefaults || desired['wd-no-defaults']) {\n    // no default or appium caps, we dont default\n    delete _desired.wdNoDefaults;\n    delete _desired['wd-no-defaults'];\n  } else {\n    // using default\n    _.defaults(_desired, this.defaultCapabilities);\n  } // http options\n\n\n  this.httpAgent = new http.Agent({\n    keepAlive: false\n  });\n  var httpOpts = httpUtils.newHttpOpts('POST', _this._httpConfig);\n  httpOpts.agent = this.httpAgent;\n  var url = httpUtils.buildInitUrl(this.configUrl);\n  var data = {}; // building request\n\n  if (_desired.allowW3C || _desired.forceW3C) {\n    data.capabilities = {\n      alwaysMatch: utils.prefixCapabilities(_desired),\n      firstMatch: [{}]\n    };\n  }\n\n  if (!_desired.forceW3C) {\n    data.desiredCapabilities = _desired;\n  }\n\n  httpUtils.emit(this, httpOpts.method, url, data);\n  httpOpts.prepareToSend(url, data);\n  httpUtils.requestWithRetry(httpOpts, this._httpConfig, this.emit.bind(this), function (err, res, data) {\n    if (err) {\n      return cb(err);\n    }\n\n    var resData;\n    var jsonData; // retrieving session\n\n    try {\n      jsonData = JSON.parse(data);\n      _this.sessionID = jsonData.value ? jsonData.value.sessionId : false;\n      _this.w3c = false;\n      resData = jsonData.value;\n\n      if (!_this.sessionID && jsonData.status === 0) {\n        _this.sessionID = jsonData.sessionId;\n        _this.w3c = true;\n      }\n    } catch (ignore) {}\n\n    if (!_this.sessionID) {\n      // attempting to retrieve the session the OLD old way\n      try {\n        var locationArr = res.headers.location.replace(/\\/$/, '').split('/');\n        _this.sessionID = locationArr[locationArr.length - 1];\n      } catch (ignore) {}\n    }\n\n    if (_this.sessionID) {\n      if (/saucelabs\\.com/.exec(url.hostname)) {\n        _this.emit('status', '\\nDriving the web on session: ' + _this.sauceTestPageRoot + '/' + _this.sessionID + '\\n');\n      } else {\n        _this.emit('status', '\\nDriving the web on session: ' + _this.sessionID + '\\n');\n      }\n\n      if (cb) {\n        cb(null, _this.sessionID, resData);\n      }\n    } else {\n      data = strip(data);\n\n      if (cb) {\n        err = new Error('The environment you requested was unavailable.' + (jsonData && jsonData.value ? '\\n' + jsonData.value.message : ''));\n        err.data = data;\n        return cb(err);\n      } else {\n        /* eslint-disable no-console */\n        console.error('\\x1b[31mError\\x1b[0m: The environment you requested was unavailable.\\n');\n        console.error('\\x1b[33mReason\\x1b[0m:\\n');\n        console.error(data);\n        console.error('\\nFor the available values please consult the WebDriver JSONWireProtocol,');\n        console.error('located at: \\x1b[33mhttp://code.google.com/p/selenium/wiki/JsonWireProtocol#/session\\x1b[0m');\n        /* eslint-enable no-console */\n      }\n    }\n  });\n}; // standard jsonwire call\n\n\nWebdriver.prototype._jsonWireCall = function (opts) {\n  var _this = this; // http options init\n\n\n  var httpOpts = httpUtils.newHttpOpts(opts.method, this._httpConfig);\n  httpOpts.agent = this.httpAgent;\n  var url = httpUtils.buildJsonCallUrl(this.noAuthConfigUrl, this.sessionID, opts.relPath, opts.absPath); // building callback\n\n  var cb = opts.cb;\n\n  if (opts.emit) {\n    // wrapping cb if we need to emit a message\n    var _cb = cb;\n\n    cb = function () {\n      var args = __slice.call(arguments, 0);\n\n      _this.emit(opts.emit.event, opts.emit.message);\n\n      if (_cb) {\n        _cb.apply(_this, args);\n      }\n    };\n  } // logging\n\n\n  httpUtils.emit(this, httpOpts.method, url, opts.data); // writting data\n\n  var data = opts.data || {};\n  httpOpts.prepareToSend(url, data); // building request\n\n  httpUtils.requestWithRetry(httpOpts, this._httpConfig, this.emit.bind(this), function (err, res, data) {\n    if (err) {\n      return cb(err);\n    }\n\n    data = strip(data);\n    cb(null, data || \"\");\n  });\n};\n\nWebdriver.prototype._sauceJobUpdate = function (jsonData, done) {\n  var _this = this;\n\n  if (!this.configUrl || !this.configUrl.auth) {\n    return done(new Error(\"Missing auth token.\"));\n  } else if (!this.configUrl.auth.match(/^.+:.+$/)) {\n    return done(new Error(\"Invalid auth token.\"));\n  }\n\n  var jobUpdateUrl = url.resolve(this.sauceRestRoot.replace(/\\/?$/, '/'), this.configUrl.auth.replace(/:.*$/, '') + '/jobs/' + this.sessionID);\n  var httpOpts = httpUtils.newHttpOpts('PUT', this._httpConfig);\n  httpOpts.auth = {\n    user: this.configUrl.auth.split(':')[0],\n    pass: this.configUrl.auth.split(':')[1]\n  };\n  httpOpts.jar = false; // disable cookies: avoids CSRF issues\n\n  httpOpts.prepareToSend(jobUpdateUrl, jsonData);\n  httpUtils.requestWithoutRetry(httpOpts, this.emit.bind(this), function (err, resp) {\n    if (err) {\n      return done(err);\n    }\n\n    if (resp.statusCode !== 200) {\n      return done(new Error(\"Sauce job update failed with http status code:\" + resp.statusCode));\n    }\n\n    httpUtils.emit(_this, 'POST', '/rest/v1/:user/jobs/:sessionID', jsonData);\n    done();\n  });\n};\n\n_(commands).each(function (fn, name) {\n  Webdriver.prototype[name] = function () {\n    var _this = this;\n\n    var fargs = utils.varargs(arguments);\n    this.emit('command', \"CALL\", name + niceArgs(fargs.all));\n\n    var cb = function (err) {\n      if (err) {\n        err.message = '[' + name + niceArgs(fargs.all) + \"] \" + err.message;\n\n        if (fargs.callback) {\n          fargs.callback(err);\n        }\n      } else {\n        var cbArgs = __slice.call(arguments, 0);\n\n        _this.emit('command', \"RESPONSE\", name + niceArgs(fargs.all), niceResp(_.drop(cbArgs)));\n\n        if (fargs.callback) {\n          fargs.callback.apply(null, cbArgs);\n        }\n      }\n    };\n\n    var args = fargs.all.concat([cb]);\n    return fn.apply(this, args);\n  };\n});","map":{"version":3,"sources":["/home/yanxiaoyang/react-project/PersonalWebsiteTest/node_modules/wd/lib/webdriver.js"],"names":["EventEmitter","require","_","util","url","http","__slice","Array","prototype","slice","utils","findCallback","niceArgs","niceResp","strip","deprecator","httpUtils","config","Element","commands","SAUCE_API_HOST","process","env","Webdriver","module","exports","configUrl","call","sessionID","httpAgent","sauceTestPageRoot","sauceRestRoot","noAuthConfigUrl","parse","format","auth","defaultCapabilities","browserName","version","javascriptEnabled","platform","_httpConfig","clone","httpConfig","inherits","newElement","jsonWireElement","attach","cb","arguments","detach","chain","obj","warn","patch","_init","_this","fargs","varargs","callback","desired","all","_desired","deviceName","device","wdNoDefaults","defaults","Agent","keepAlive","httpOpts","newHttpOpts","agent","buildInitUrl","data","allowW3C","forceW3C","capabilities","alwaysMatch","prefixCapabilities","firstMatch","desiredCapabilities","emit","method","prepareToSend","requestWithRetry","bind","err","res","resData","jsonData","JSON","value","sessionId","w3c","status","ignore","locationArr","headers","location","replace","split","length","exec","hostname","Error","message","console","error","_jsonWireCall","opts","buildJsonCallUrl","relPath","absPath","_cb","args","event","apply","_sauceJobUpdate","done","match","jobUpdateUrl","resolve","user","pass","jar","requestWithoutRetry","resp","statusCode","each","fn","name","cbArgs","drop","concat"],"mappings":"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","sourcesContent":["var EventEmitter = require('events').EventEmitter,\n    _ = require(\"lodash\"),\n    util = require( 'util' ),\n    url = require('url'),\n    http = require('http'),\n    __slice = Array.prototype.slice,\n    utils = require(\"./utils\"),\n    findCallback = utils.findCallback,\n    niceArgs = utils.niceArgs,\n    niceResp = utils.niceResp,\n    strip = utils.strip,\n    deprecator = utils.deprecator,\n    httpUtils = require('./http-utils'),\n    config = require('./config'),\n    Element = require('./element'),\n    commands = require('./commands'),\n    SAUCE_API_HOST = process.env[\"SAUCE_API_HOST\"] || \"saucelabs.com\";\n\n// Webdriver client main class\n// configUrl: url object constructed via url.parse\nvar Webdriver = module.exports = function(configUrl) {\n  EventEmitter.call( this );\n  this.sessionID = null;\n  this.httpAgent = null;\n  this.configUrl = configUrl;\n  this.sauceTestPageRoot = \"https://\" + SAUCE_API_HOST + \"/jobs\";\n  this.sauceRestRoot = \"https://\" + SAUCE_API_HOST + \"/rest/v1\";\n  // config url without auth\n  this.noAuthConfigUrl = url.parse(url.format(this.configUrl));\n  delete this.noAuthConfigUrl.auth;\n\n  this.defaultCapabilities = {\n    browserName: 'firefox'\n     , version: ''\n    , javascriptEnabled: true\n    , platform: 'ANY'\n  };\n\n  this._httpConfig = _.clone(config.httpConfig);\n};\n\n//inherit from EventEmitter\nutil.inherits( Webdriver, EventEmitter );\n\n// creates a new element\nWebdriver.prototype.newElement = function(jsonWireElement) {\n  return new Element(jsonWireElement, this);\n};\n\n/**\n * attach(sessionID, cb) -> cb(err)\n * Connect to an already-active session.\n */\nWebdriver.prototype.attach = function(sessionID) {\n  var cb = findCallback(arguments);\n  this.sessionID = sessionID;\n  if(cb) { cb(null); }\n};\n\n/**\n * detach(cb) -> cb(err)\n * Detach from the current session.\n */\nWebdriver.prototype.detach = function() {\n  var cb = findCallback(arguments);\n  this.sessionID = null;\n  if(cb) { cb(null); }\n};\n\ncommands.chain = function(obj){\n  deprecator.warn('chain', 'chain api has been deprecated, use promise chain instead.');\n  require(\"./deprecated-chain\").patch(this);\n  return this.chain(obj);\n};\n\nWebdriver.prototype._init = function() {\n  delete this.sessionID;\n  var _this = this;\n  var fargs = utils.varargs(arguments);\n  var cb = fargs.callback,\n      desired = fargs.all[0] || {};\n\n  var _desired = _.clone(desired);\n\n  if(desired.deviceName || desired.device || desired.wdNoDefaults ||\n     desired['wd-no-defaults']) {\n    // no default or appium caps, we dont default\n    delete _desired.wdNoDefaults;\n    delete _desired['wd-no-defaults'];\n  } else {\n    // using default\n    _.defaults(_desired, this.defaultCapabilities);\n  }\n\n  // http options\n  this.httpAgent = new http.Agent({ keepAlive: false });\n  var httpOpts = httpUtils.newHttpOpts('POST', _this._httpConfig);\n      httpOpts.agent = this.httpAgent;\n\n  var url = httpUtils.buildInitUrl(this.configUrl);\n\n  var data = {};\n\n  // building request\n  if (_desired.allowW3C || _desired.forceW3C) {\n    data.capabilities = {\n      alwaysMatch: utils.prefixCapabilities(_desired),\n      firstMatch: [{}],\n    };\n  }\n\n  if (!_desired.forceW3C) {\n    data.desiredCapabilities = _desired;\n  }\n  httpUtils.emit(this, httpOpts.method, url, data);\n\n  httpOpts.prepareToSend(url, data);\n\n  httpUtils.requestWithRetry(httpOpts, this._httpConfig, this.emit.bind(this), function(err, res, data) {\n    if(err) { return cb(err); }\n\n    var resData;\n    var jsonData;\n\n    // retrieving session\n    try{\n      jsonData = JSON.parse(data);\n      _this.sessionID = jsonData.value ? jsonData.value.sessionId : false;\n      _this.w3c = false;\n      resData = jsonData.value;\n      if(!_this.sessionID && jsonData.status === 0 ){\n        _this.sessionID = jsonData.sessionId;\n        _this.w3c = true;\n      }\n    } catch(ignore){}\n    if(!_this.sessionID){\n      // attempting to retrieve the session the OLD old way\n      try{\n        var locationArr = res.headers.location.replace(/\\/$/, '').split('/');\n        _this.sessionID = locationArr[locationArr.length - 1];\n      } catch(ignore){}\n    }\n\n    if (_this.sessionID) {\n      if (/saucelabs\\.com/.exec(url.hostname)) {\n        _this.emit('status', '\\nDriving the web on session: ' + _this.sauceTestPageRoot + '/' + _this.sessionID + '\\n');\n      } else {\n        _this.emit('status', '\\nDriving the web on session: ' + _this.sessionID + '\\n');\n      }\n      if (cb) { cb(null, _this.sessionID, resData); }\n    } else {\n      data = strip(data);\n      if (cb) {\n        err = new Error('The environment you requested was unavailable.' + ((jsonData && jsonData.value) ? ('\\n' + jsonData.value.message) : ''));\n        err.data = data;\n        return cb(err);\n      } else {\n        /* eslint-disable no-console */\n        console.error('\\x1b[31mError\\x1b[0m: The environment you requested was unavailable.\\n');\n        console.error('\\x1b[33mReason\\x1b[0m:\\n');\n        console.error(data);\n        console.error('\\nFor the available values please consult the WebDriver JSONWireProtocol,');\n        console.error('located at: \\x1b[33mhttp://code.google.com/p/selenium/wiki/JsonWireProtocol#/session\\x1b[0m');\n        /* eslint-enable no-console */\n      }\n    }\n  });\n};\n\n// standard jsonwire call\nWebdriver.prototype._jsonWireCall = function(opts) {\n  var _this = this;\n\n  // http options init\n  var httpOpts = httpUtils.newHttpOpts(opts.method, this._httpConfig);\n      httpOpts.agent = this.httpAgent;\n\n  var url = httpUtils.buildJsonCallUrl(this.noAuthConfigUrl, this.sessionID, opts.relPath, opts.absPath);\n\n  // building callback\n  var cb = opts.cb;\n  if (opts.emit) {\n    // wrapping cb if we need to emit a message\n    var _cb = cb;\n    cb = function() {\n      var args = __slice.call(arguments, 0);\n      _this.emit(opts.emit.event, opts.emit.message);\n      if (_cb) { _cb.apply(_this,args); }\n    };\n  }\n\n  // logging\n  httpUtils.emit(this, httpOpts.method, url, opts.data);\n\n  // writting data\n  var data = opts.data || {};\n  httpOpts.prepareToSend(url, data);\n  // building request\n  httpUtils.requestWithRetry(httpOpts, this._httpConfig, this.emit.bind(this), function(err, res, data) {\n    if(err) { return cb(err); }\n    data = strip(data);\n    cb(null, data || \"\");\n  });\n};\n\nWebdriver.prototype._sauceJobUpdate = function(jsonData, done) {\n  var _this = this;\n  if(!this.configUrl || !this.configUrl.auth){\n    return done(new Error(\"Missing auth token.\"));\n  } else if(!this.configUrl.auth.match(/^.+:.+$/)){\n    return done(new Error(\"Invalid auth token.\"));\n  }\n  var jobUpdateUrl = url.resolve(\n    this.sauceRestRoot.replace(/\\/?$/,'/'),\n    this.configUrl.auth.replace(/:.*$/,'') + '/jobs/' + this.sessionID);\n\n  var httpOpts = httpUtils.newHttpOpts('PUT', this._httpConfig);\n  httpOpts.auth = {\n    user: this.configUrl.auth.split(':')[0],\n    pass: this.configUrl.auth.split(':')[1],\n  };\n  httpOpts.jar = false; // disable cookies: avoids CSRF issues\n  httpOpts.prepareToSend(jobUpdateUrl, jsonData);\n\n  httpUtils.requestWithoutRetry(httpOpts, this.emit.bind(this), function(err, resp) {\n    if(err) { return done(err); }\n    if(resp.statusCode !== 200) {\n      return done(new Error(\"Sauce job update failed with http status code:\" +\n        resp.statusCode));\n    }\n    httpUtils.emit(_this, 'POST', '/rest/v1/:user/jobs/:sessionID', jsonData);\n    done();\n  });\n};\n\n_(commands).each(function(fn, name) {\n  Webdriver.prototype[name] = function() {\n    var _this = this;\n    var fargs = utils.varargs(arguments);\n    this.emit('command', \"CALL\" , name + niceArgs(fargs.all));\n    var cb = function(err) {\n      if(err) {\n        err.message = '[' + name + niceArgs(fargs.all) + \"] \" + err.message;\n        if(fargs.callback) { fargs.callback(err); }\n      } else {\n        var cbArgs = __slice.call(arguments, 0);\n        _this.emit('command', \"RESPONSE\" , name + niceArgs(fargs.all),\n          niceResp(_.drop(cbArgs)));\n        if(fargs.callback) { fargs.callback.apply(null, cbArgs); }\n      }\n    };\n    var args = fargs.all.concat([cb]);\n    return fn.apply(this, args);\n  };\n});\n"]},"metadata":{},"sourceType":"script"}